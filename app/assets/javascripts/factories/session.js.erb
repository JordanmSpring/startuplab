angular.module('StartupLab').factory('Session', function($location, $http, $q) {
  // Redirect to the given url (defaults to '/')
  function redirect(url) {
    url = url || '/';
    $location.path(url);
  }

  var session = {
    currentUser: null,

    isAuthenticated: function() {
      return !!this.currentUser;
    },

    login: function(email, password, failure) {
       return $http.post('/users/sign_in', {user: {email: email, password: password} })
      .then(function(response) {
        session.currentUser = response.data.user;
        if (session.isAuthenticated()) {
          //TODO: Send them back to where they came from
          //$location.path(response.data.redirect);
          redirect('/');
        }
      }, function(error) {
        failure();
      });
    },

    logout: function(redirectTo) {
      $http.delete('/users/sign_out').then(function() {
        session.currentUser = null;
        redirect(redirectTo);
      }, function() {
        alert('Could not log out');
      });
    },

    register: function(user) {
      return $http.post('/users.json', {
        user: {
          name: user.name,
          email: user.email,
          password: user.password,
          password_confirmation: user.passwordConfirmation
        }
      }).then(function(response) {
        console.log('response', response.data);
        session.currentUser = response.data;
        if (session.isAuthenticated()) {
          $location.path('/ideas');
        }
      }, function(response) {
        // TODO: Display above form
        alert(response.data.errors);
      });
    },

    // TODO: Use the User service
    requestCurrentUser: function() {
      return $http.get('/api/users/current.json').then(function(response) {
        console.log(response.data);
        session.currentUser = response.data;
        return session.currentUser;
      }, function() {
        console.log('Unable to get user')
      });
    }
  };

  session.requestCurrentUser();

  return session;
});
