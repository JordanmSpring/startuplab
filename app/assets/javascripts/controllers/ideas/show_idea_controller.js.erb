angular.module('StartupLab')
.controller('ShowIdeaController', ['$scope', '$routeParams', '$location', 'Idea', 'Session', 'user',
    function($scope, $routeParams, $location, Idea, Session, user) {

  $scope.session = Session;

  // TODO: Use a resolver in the routes
  Idea.find($routeParams.id).then(function(response) {
    $scope.idea = response.data;

    if ($routeParams['vote'] && $scope.session.isAuthenticated()) {
      $scope.vote()
      // Remove the 'vote' and 'origin' params after login.
      $location.url('/ideas/' + $scope.idea.id);
    }
  });

  /* Init isotope */
  $('.grid').isotope({
    itemSelector: '.grid-item',
    masonry: {
      // use outer width of grid-sizer for columnWidth
      columnWidth: 191
    },
    sortBy: 'original-order'
  });

  var publish = function() {
    if (confirm('Are you sure you want to make this idea public?')) {
      Idea.publish($scope.idea).then(function() {
        $scope.idea.published = true;
        // We need to refresh the user in case they try to downgrade later to a
        // plan that doesn't allow published plans.
        Session.refreshCurrentUser();
      }, function() {
        alert('Sorry, the idea could not be published. If this problem continues, contact support.');
      });
    }
  };

  var unpublish = function() {
    if (confirm('Are you sure you want to make this idea private?')) {
      Idea.unpublish($scope.idea).then(function() {
        $scope.idea.published = false;
        // We need to refresh the user in case they try to downgrade later to a
        // plan that doesn't allow published plans.
        Session.refreshCurrentUser();
      }, function() {
        alert('Sorry, this idea could not be made private. If this problem continues, contact support.');
      });
    }
  };

  $scope.vote = function() {
      Idea.vote($scope.idea).then(function(response) {
        $scope.idea.voted = true;
        $scope.idea.votes = response.data;
      }, function() {
        alert('Sorry, you could not vote for this idea. If this problem continues, contact support.');
      });
  };

  $scope.unvote = function() {
      Idea.unvote($scope.idea).then(function(response) {
        $scope.idea.voted = false;
        $scope.idea.votes = response.data;
      }, function() {
        alert('Sorry, you could remove your vote for this idea. If this problem continues, contact support.');
      });
  };

  $scope.delete = function() {
    if (confirm('Are you sure you want to delete this idea?')) {
      Idea.delete($scope.idea).then(function() {
      // We need to refresh the user to see if they have reached any limits.
        Session.refreshCurrentUser();
        $location.path('/dashboard');
      }, function() {
        alert('Sorry, this idea could not be deleted. If this problem continues, contact support.');
      });
    }
  };

  var togglePublicState = function(newVal, oldVal) {
    if (newVal == true && oldVal == false) {
      publish();
    } else if (newVal == false && oldVal == true) {
      unpublish();
    }
  }
  $scope.$watch('idea.published', togglePublicState);
}]);
